<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø¹Ø·ÙˆØ± Ø§Ù„Ø£Ù†Ø§Ù‚Ø© â€“ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙØ§Ø®Ø±</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;900&display=swap');
  
  :root {
    --gold: #d4af37;
    --gold-dim: #b59020;
    --black: #0f0f0f;
    --dark-grey: #1a1a1a;
    --light-grey: #2c2c2c;
    --white: #f0f0f0;
    --red: #e74c3c;
    --green: #2ecc71;
    --blue: #3498db;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; outline: none; }
  body { background: var(--black); color: var(--white); direction: rtl; padding-bottom: 80px; }

  /* Header */
  header {
    background: linear-gradient(180deg, rgba(0,0,0,0.9), transparent);
    text-align: center;
    padding: 30px 20px;
    border-bottom: 1px solid #333;
  }
  header h1 { color: var(--gold); font-size: 2.5rem; letter-spacing: 1px; margin-bottom: 5px; font-weight: 900; }
  header p { color: #aaa; font-size: 0.9rem; }

  /* Layout */
  .container { max-width: 800px; margin: auto; padding: 15px; }
  .section { background: var(--dark-grey); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 1px solid #333; }
  
  h2, h3 { color: var(--gold); margin-bottom: 15px; border-bottom: 2px solid var(--gold-dim); display: inline-block; padding-bottom: 5px; }

  /* Forms & Inputs */
  label { display: block; margin-top: 10px; font-weight: bold; color: #ccc; }
  input, select, textarea, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #444; background: var(--light-grey); color: #fff; font-size: 1rem; transition: 0.3s; }
  input:focus, textarea:focus { border-color: var(--gold); }
  
  button { background: var(--gold); color: #000; font-weight: bold; cursor: pointer; border: none; }
  button:hover { background: var(--gold-dim); transform: translateY(-2px); }
  button.danger { background: var(--red); color: white; }
  button.secondary { background: #444; color: white; }
  button.info { background: var(--blue); color: white; }

  /* Products Grid */
  .grid-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
  
  /* Cards */
  .card { background: var(--light-grey); padding: 10px; border-radius: 10px; text-align: center; position: relative; border: 1px solid #333; transition: 0.3s; cursor: pointer; }
  .card:hover { border-color: var(--gold); transform: translateY(-3px); }
  .card.selected { border: 2px solid var(--gold); background: #252525; }
  
  .card img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; background: #000; }
  .card h4 { font-size: 0.9rem; margin-bottom: 5px; height: 35px; overflow: hidden; }
  .card .price { color: var(--gold); font-weight: bold; font-size: 1.1rem; }
  .badge { position: absolute; top: 5px; right: 5px; background: var(--red); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }

  /* Cart */
  .cart-item { display: flex; justify-content: space-between; align-items: center; background: #252525; padding: 10px; margin-bottom: 8px; border-radius: 8px; border-right: 3px solid var(--gold); }
  .cart-total { text-align: center; font-size: 1.3rem; margin-top: 15px; color: var(--gold); font-weight: bold; }

  /* Admin Button */
  .admin-float { position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px; background: var(--gold); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 999; }

  /* Admin Panel */
  .admin-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto; padding: 20px; }
  .admin-box { max-width: 900px; margin: 0 auto; background: #151515; padding: 20px; border-radius: 12px; border: 1px solid var(--gold); }
  .close-btn { float: left; font-size: 2rem; cursor: pointer; color: var(--red); line-height: 20px; }
  
  .admin-table-item { display: flex; gap: 10px; align-items: center; background: #222; padding: 10px; margin-bottom: 5px; border-radius: 5px; }
  .admin-table-item img { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; }
  .admin-table-item .info { flex: 1; }
  .admin-actions { display: flex; gap: 5px; }
  .admin-actions button { padding: 5px 10px; font-size: 0.8rem; width: auto; }

  /* Helper Classes */
  .hidden { display: none; }
  .flex-row { display: flex; gap: 10px; }
  .flex-row input { flex: 1; }
  
  /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© */
  .image-upload-container { 
    background: #222; 
    padding: 15px; 
    border-radius: 8px; 
    margin: 10px 0; 
    border: 1px dashed #444;
  }
  
  .image-options {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
  }
  
  .image-option-btn {
    flex: 1;
    min-width: 120px;
    padding: 8px;
    text-align: center;
  }
  
  .progress-bar {
    height: 5px;
    background: #333;
    border-radius: 5px;
    margin-top: 5px;
    overflow: hidden;
  }
  
  .progress-fill {
    height: 100%;
    background: var(--green);
    width: 0%;
    transition: width 0.3s;
  }
  
  .image-preview-container {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .image-size-info {
    font-size: 0.8rem;
    color: #aaa;
    text-align: center;
    margin-top: 5px;
  }
  
  .upload-status {
    padding: 5px 10px;
    border-radius: 5px;
    margin-top: 5px;
    text-align: center;
    font-size: 0.9rem;
  }
  
  .upload-success { background: rgba(46, 204, 113, 0.2); color: var(--green); }
  .upload-error { background: rgba(231, 76, 60, 0.2); color: var(--red); }
  
  .drive-url-input {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }
  
  .drive-url-input input {
    flex: 3;
  }
  
  .drive-url-input button {
    flex: 1;
  }
</style>
</head>
<body>

<header>
  <h1>Ø¹Ø·ÙˆØ± Ø§Ù„Ø£Ù†Ø§Ù‚Ø©</h1>
  <p>Ø£ÙØ®Ù… Ø§Ù„Ø¹Ø·ÙˆØ± Ø¨Ù„Ù…Ø³Ø§ØªÙƒ Ø§Ù„Ø®Ø§ØµØ©</p>
</header>

<div class="container">
  
  <div class="section" id="step1">
    <h2>1. Ø§Ø®ØªØ± Ø­Ø¬Ù… ÙˆØ´ÙƒÙ„ Ø§Ù„Ø²Ø¬Ø§Ø¬Ø©</h2>
    <div id="bottlesGrid" class="grid-list"></div>
  </div>

  <div class="section hidden" id="step2">
    <h2>2. Ø§Ø®ØªØ± Ø¹Ø·Ø±Ùƒ Ø§Ù„Ù…ÙØ¶Ù„</h2>
    <input type="text" id="searchPerfume" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø¹Ø·Ø±..." oninput="renderPerfumes()">
    <div class="flex-row" style="margin-bottom:10px;">
      <select onchange="sortPerfumes(this.value)" style="width:50%">
        <option value="default">ØªØ±ØªÙŠØ¨ Ø§ÙØªØ±Ø§Ø¶ÙŠ</option>
        <option value="low">Ø§Ù„Ø£Ù‚Ù„ Ø³Ø¹Ø±Ø§Ù‹</option>
        <option value="high">Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±Ø§Ù‹</option>
      </select>
    </div>
    <div id="perfumesGrid" class="grid-list"></div>
  </div>

  <div class="section hidden" id="cartSection">
    <h2>Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
    <div id="cartList"></div>
    <div class="cart-total" id="cartTotalDisplay">0 Ø¯Ø¬</div>
    
    <hr style="border-color:#444; margin: 15px 0;">
    
    <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</h3>
    <input type="text" id="custName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
    <input type="tel" id="custPhone" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ (Ù„Ù„ØªÙˆØ§ØµÙ„)">
    <input type="text" id="custAddress" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„ (ÙˆÙ‡Ø±Ø§Ù† - Ø§Ù„Ø­ÙŠ/Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©)">
    <textarea id="custNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
    
    <button onclick="sendWhatsAppOrder()" style="background:#25D366; color:#fff; font-size:1.2rem;">
      âœ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
    </button>
  </div>

</div>

<div class="admin-float" onclick="openAdmin()">âš™ï¸</div>

<div id="adminPanel" class="admin-overlay">
  <div class="admin-box">
    <span class="close-btn" onclick="document.getElementById('adminPanel').style.display='none'">&times;</span>
    <h2 style="text-align:center;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h2>
    
    <div style="background:#222; padding:10px; border-radius:8px; margin-bottom:20px;">
      <label>Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø¯Ø¬):</label>
      <div class="flex-row">
        <input type="number" id="shipPriceInput">
        <button onclick="saveShipPrice()" style="width:100px;">Ø­ÙØ¸</button>
      </div>
    </div>

    <div style="display:flex; gap:10px; margin-bottom:15px;">
      <button onclick="switchAdminTab('perfumes')" id="tabPerfumes">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø·ÙˆØ±</button>
      <button onclick="switchAdminTab('bottles')" id="tabBottles" class="secondary">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²Ø¬Ø§Ø¬Ø§Øª</button>
    </div>

    <div id="addForm" style="background:#222; padding:15px; border-radius:8px; margin-bottom:20px;">
      <h3 id="formTitle">Ø¥Ø¶Ø§ÙØ© Ø¹Ø·Ø± Ø¬Ø¯ÙŠØ¯</h3>
      <input type="hidden" id="editIndex" value="-1">
      <input id="prodName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
      <div class="flex-row">
        <input type="number" id="prodPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±">
        <input type="number" id="prodCapacity" placeholder="Ø§Ù„Ø³Ø¹Ø© (Ù„Ù„Ø²Ø¬Ø§Ø¬Ø§Øª ÙÙ‚Ø·)" style="display:none">
      </div>
      
      <!-- Ù‚Ø³Ù… ØªØ­Ø³ÙŠÙ† Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± -->
      <div class="image-upload-container">
        <label>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬:</label>
        
        <div class="image-options">
          <button type="button" onclick="showUploadOption('file')" class="image-option-btn secondary" id="btnUploadFile">
            ğŸ“ Ø±ÙØ¹ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ
          </button>
          <button type="button" onclick="showUploadOption('drive')" class="image-option-btn info" id="btnUploadDrive">
            â˜ï¸ Ø±Ø§Ø¨Ø· Google Drive
          </button>
          <button type="button" onclick="showUploadOption('cloudinary')" class="image-option-btn" id="btnUploadCloudinary">
            ğŸŒ©ï¸ Ø±ÙØ¹ Cloudinary
          </button>
        </div>
        
        <!-- Ø®ÙŠØ§Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù -->
        <div id="uploadFileOption" class="upload-option">
          <div class="flex-row">
            <input type="file" id="imgInput" accept="image/*" onchange="handleImageUpload()">
            <button onclick="clearImageInput()" class="secondary" style="width:50px">X</button>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="uploadProgress"></div>
          </div>
        </div>
        
        <!-- Ø®ÙŠØ§Ø± Google Drive -->
        <div id="uploadDriveOption" class="upload-option hidden">
          <div class="drive-url-input">
            <input type="text" id="driveUrl" placeholder="https://drive.google.com/file/d/...">
            <button onclick="fetchDriveImage()">Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø©</button>
          </div>
          <div id="driveStatus" class="upload-status"></div>
        </div>
        
        <!-- Ø®ÙŠØ§Ø± Cloudinary -->
        <div id="uploadCloudinaryOption" class="upload-option hidden">
          <div class="flex-row">
            <input type="file" id="cloudinaryInput" accept="image/*">
            <button onclick="uploadToCloudinary()" class="info">Ø±ÙØ¹ Ø¥Ù„Ù‰ Cloudinary</button>
          </div>
          <div id="cloudinaryStatus" class="upload-status"></div>
        </div>
        
        <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© -->
        <div class="image-preview-container">
          <img id="imgPreview" src="" style="width:120px; height:120px; object-fit:cover; display:none; border:2px solid var(--gold); border-radius:8px;">
          <div style="flex:1; min-width:200px;">
            <div id="imageInfo" class="image-size-info"></div>
            <div id="uploadStatus" class="upload-status"></div>
          </div>
        </div>
        
        <input type="hidden" id="imgData">
      </div>
      
      <textarea id="prodDesc" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬ (Ù„Ù„Ø¹Ø·ÙˆØ±)" style="height:60px;"></textarea>
      
      <div class="flex-row" id="perfumeOptions">
        <label style="flex:1"><input type="checkbox" id="isDiscount"> ØªØ®ÙÙŠØ¶</label>
        <label style="flex:1"><input type="checkbox" id="isPinned"> Ù…Ø«Ø¨Øª (ÙŠØ¸Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹)</label>
      </div>
      
      <div class="flex-row">
        <button onclick="saveProduct()">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
        <button onclick="resetForm()" class="secondary">Ø¥Ù„ØºØ§Ø¡ / Ø¬Ø¯ÙŠØ¯</button>
      </div>
    </div>

    <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
    <div id="adminList"></div>

  </div>
</div>

<script>
  /* --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª --- */
  const ADMIN_PHONE = "213795795754"; // Ø±Ù‚Ù…Ùƒ Ø¨Ø¯ÙˆÙ† +
  const ADMIN_PASS = "abdou123456";   // ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Cloudinary
  const CLOUDINARY_CLOUD_NAME = "dtkgml8yg";
  const CLOUDINARY_UPLOAD_PRESET = "products";
  const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

  let data = {
    perfumes: JSON.parse(localStorage.getItem('perfumes')) || [],
    bottles: JSON.parse(localStorage.getItem('bottles')) || [],
    shipping: parseInt(localStorage.getItem('shipping')) || 400
  };
  
  let cart = [];
  let currentBottleIdx = null;
  let adminCurrentTab = 'perfumes'; // 'perfumes' or 'bottles'
  let currentUploadOption = 'file';

  /* --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ø¯Ø¡ --- */
  window.onload = function() {
    renderBottlesUser();
    document.getElementById('shipPriceInput').value = data.shipping;
    showUploadOption('file'); // Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø± Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
  };

  /* --- ØªØ­Ø³ÙŠÙ†Ø§Øª Ù†Ø¸Ø§Ù… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± --- */
  
  function showUploadOption(option) {
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
    document.getElementById('uploadFileOption').classList.add('hidden');
    document.getElementById('uploadDriveOption').classList.add('hidden');
    document.getElementById('uploadCloudinaryOption').classList.add('hidden');
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    document.getElementById('btnUploadFile').className = 'image-option-btn secondary';
    document.getElementById('btnUploadDrive').className = 'image-option-btn info';
    document.getElementById('btnUploadCloudinary').className = 'image-option-btn';
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
    document.getElementById(`upload${option.charAt(0).toUpperCase() + option.slice(1)}Option`).classList.remove('hidden');
    
    // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø·
    document.getElementById(`btnUpload${option.charAt(0).toUpperCase() + option.slice(1)}`).className = 'image-option-btn';
    
    currentUploadOption = option;
  }

  function clearImageInput() {
    document.getElementById('imgInput').value = '';
    document.getElementById('cloudinaryInput').value = '';
    document.getElementById('driveUrl').value = '';
    document.getElementById('imgPreview').style.display = 'none';
    document.getElementById('imgData').value = '';
    document.getElementById('imageInfo').innerHTML = '';
    document.getElementById('uploadStatus').innerHTML = '';
    document.getElementById('driveStatus').innerHTML = '';
    document.getElementById('cloudinaryStatus').innerHTML = '';
    document.getElementById('uploadProgress').style.width = '0%';
  }

  /* --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± Ù…Ø¹ Ø¶ØºØ· Ø°ÙƒÙŠ --- */
  async function handleImageUpload() {
    const fileInput = document.getElementById('imgInput');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
    if (!file.type.match('image.*')) {
      showUploadStatus('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø© ÙÙ‚Ø·', 'error');
      return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB)
    if (file.size > 5 * 1024 * 1024) {
      showUploadStatus('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB)', 'error');
      return;
    }
    
    // Ø¹Ø±Ø¶ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
    const progressBar = document.getElementById('uploadProgress');
    progressBar.style.width = '30%';
    
    try {
      // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©
      const reader = new FileReader();
      
      reader.onload = async function(event) {
        const img = new Image();
        img.src = event.target.result;
        
        img.onload = async function() {
          // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬
          let maxWidth, maxHeight, quality;
          
          if (adminCurrentTab === 'perfumes') {
            // Ù„Ù„Ø¹Ø·ÙˆØ±: ØµÙˆØ± Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø­Ø¬Ù…
            maxWidth = 400;
            maxHeight = 400;
            quality = 0.8;
          } else {
            // Ù„Ù„Ø²Ø¬Ø§Ø¬Ø§Øª: ØµÙˆØ± Ø£ØµØºØ±
            maxWidth = 300;
            maxHeight = 300;
            quality = 0.7;
          }
          
          // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹
          let width = img.width;
          let height = img.height;
          
          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }
          
          if (height > maxHeight) {
            width = (width * maxHeight) / height;
            height = maxHeight;
          }
          
          // Ø¥Ù†Ø´Ø§Ø¡ Canvas ÙˆØ¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = width;
          canvas.height = height;
          
          // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¶ØºÙˆØ·Ø©
          ctx.drawImage(img, 0, 0, width, height);
          progressBar.style.width = '70%';
          
          // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Base64
          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          
          // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©
          document.getElementById('imgData').value = dataUrl;
          document.getElementById('imgPreview').src = dataUrl;
          document.getElementById('imgPreview').style.display = 'block';
          
          // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙˆØ±Ø©
          const originalSize = formatBytes(file.size);
          const compressedSize = formatBytes(dataUrl.length * 0.75); // ØªÙ‚Ø¯ÙŠØ± Ø­Ø¬Ù… Base64
          const compressionRatio = Math.round((1 - (dataUrl.length * 0.75 / file.size)) * 100);
          
          document.getElementById('imageInfo').innerHTML = `
            <div>Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯: ${Math.round(width)} Ã— ${Math.round(height)} Ø¨ÙƒØ³Ù„</div>
            <div>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£ØµÙ„ÙŠ: ${originalSize} | Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ·: ${compressedSize}</div>
            <div>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶ØºØ·: ${compressionRatio}%</div>
          `;
          
          progressBar.style.width = '100%';
          showUploadStatus('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
          
          // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©
          setTimeout(() => {
            progressBar.style.width = '0%';
          }, 1000);
        };
        
        img.onerror = function() {
          showUploadStatus('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©', 'error');
          progressBar.style.width = '0%';
        };
      };
      
      reader.onerror = function() {
        showUploadStatus('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù', 'error');
        progressBar.style.width = '0%';
      };
      
      reader.readAsDataURL(file);
      
    } catch (error) {
      showUploadStatus(`âŒ Ø®Ø·Ø£: ${error.message}`, 'error');
      progressBar.style.width = '0%';
    }
  }

  /* --- Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ± Ù…Ù† Google Drive --- */
  async function fetchDriveImage() {
    const driveUrl = document.getElementById('driveUrl').value.trim();
    const statusDiv = document.getElementById('driveStatus');
    
    if (!driveUrl) {
      statusDiv.innerHTML = '<div class="upload-error">âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Google Drive</div>';
      return;
    }
    
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø±Ø§Ø¨Ø· Google Drive
    let fileId = '';
    
    // Ù†Ù…Ø· Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ù„Ù€ Google Drive
    const patterns = [
      /\/file\/d\/([a-zA-Z0-9_-]+)/,
      /id=([a-zA-Z0-9_-]+)/,
      /([a-zA-Z0-9_-]{25,})/
    ];
    
    for (const pattern of patterns) {
      const match = driveUrl.match(pattern);
      if (match && match[1]) {
        fileId = match[1];
        break;
      }
    }
    
    if (!fileId) {
      statusDiv.innerHTML = '<div class="upload-error">âŒ Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­. ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØµØ­ÙŠØ­</div>';
      return;
    }
    
    statusDiv.innerHTML = '<div>â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø©...</div>';
    
    try {
      // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ØµÙˆØ±Ø© Ù…Ù† Google Drive
      const directUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
      
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… proxy Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± Ù„ØªØ¬Ø§ÙˆØ² CORS
      const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(directUrl)}`;
      
      // Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø©
      const response = await fetch(proxyUrl);
      
      if (!response.ok) {
        throw new Error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø©');
      }
      
      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ blob
      const blob = await response.blob();
      
      // Ø¥Ù†Ø´Ø§Ø¡ File Ù…Ù† Blob
      const file = new File([blob], "drive-image.jpg", { type: blob.type });
      
      // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      document.getElementById('imgInput').files = dataTransfer.files;
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©
      await handleImageUpload();
      
      statusDiv.innerHTML = '<div class="upload-success">âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Google Drive</div>';
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ØµÙˆØ±Ø© Drive:', error);
      statusDiv.innerHTML = `<div class="upload-error">âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø©: ${error.message}</div>`;
    }
  }

  /* --- Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ Cloudinary --- */
  async function uploadToCloudinary() {
    const fileInput = document.getElementById('cloudinaryInput');
    const file = fileInput.files[0];
    const statusDiv = document.getElementById('cloudinaryStatus');
    
    if (!file) {
      statusDiv.innerHTML = '<div class="upload-error">âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹</div>';
      return;
    }
    
    statusDiv.innerHTML = '<div>â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ Cloudinary...</div>';
    
    try {
      // Ø¥Ù†Ø´Ø§Ø¡ FormData
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Cloudinary
      const response = await fetch(CLOUDINARY_UPLOAD_URL, {
        method: 'POST',
        body: formData
      });
      
      if (!response.ok) {
        throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹: ${response.status}`);
      }
      
      const result = await response.json();
      
      // Ø­ÙØ¸ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©
      const imageUrl = result.secure_url;
      document.getElementById('imgData').value = imageUrl;
      document.getElementById('imgPreview').src = imageUrl;
      document.getElementById('imgPreview').style.display = 'block';
      
      // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙˆØ±Ø©
      document.getElementById('imageInfo').innerHTML = `
        <div>âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ Cloudinary</div>
        <div>Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯: ${result.width} Ã— ${result.height} Ø¨ÙƒØ³Ù„</div>
        <div>Ø§Ù„Ø­Ø¬Ù…: ${formatBytes(result.bytes)}</div>
      `;
      
      statusDiv.innerHTML = '<div class="upload-success">âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Cloudinary</div>';
      showUploadStatus('âœ… ØªÙ… Ø­ÙØ¸ Ø±Ø§Ø¨Ø· Cloudinary', 'success');
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Cloudinary:', error);
      statusDiv.innerHTML = `<div class="upload-error">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹: ${error.message}</div>`;
      showUploadStatus('âŒ ÙØ´Ù„ Ø±ÙØ¹ Cloudinary', 'error');
    }
  }

  /* --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© --- */
  function showUploadStatus(message, type) {
    const statusDiv = document.getElementById('uploadStatus');
    statusDiv.innerHTML = `<div class="upload-${type}">${message}</div>`;
  }

  function formatBytes(bytes, decimals = 2) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
  }

  /* --- Ø¯ÙˆØ§Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„Ø¹Ù…ÙŠÙ„) --- */
  
  function renderBottlesUser() {
    const grid = document.getElementById('bottlesGrid');
    grid.innerHTML = '';
    data.bottles.forEach((b, index) => {
      grid.innerHTML += `
        <div class="card ${currentBottleIdx === index ? 'selected' : ''}" onclick="selectBottle(${index})">
          <img src="${b.img || 'https://via.placeholder.com/150?text=Ø²Ø¬Ø§Ø¬Ø©'}" loading="lazy" onerror="this.src='https://via.placeholder.com/150?text=Ø²Ø¬Ø§Ø¬Ø©'">
          <h4>${b.name}</h4>
          <div class="price">${b.capacity} Ù…Ù„ | ${b.price} Ø¯Ø¬</div>
        </div>
      `;
    });
  }

  function selectBottle(index) {
    currentBottleIdx = index;
    renderBottlesUser(); // Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø±
    document.getElementById('step2').classList.remove('hidden');
    renderPerfumes();
    // ØªÙ…Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø£Ø³ÙÙ„
    document.getElementById('step2').scrollIntoView({behavior: 'smooth'});
  }

  function renderPerfumes() {
    const grid = document.getElementById('perfumesGrid');
    grid.innerHTML = '';
    const search = document.getElementById('searchPerfume').value.toLowerCase();
    
    // Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
    let list = data.perfumes.filter(p => p.name.toLowerCase().includes(search));
    
    // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ±ØªÙŠØ¨ (Ø§Ù„Ù…Ø«Ø¨Øª Ø£ÙˆÙ„Ø§Ù‹ Ø¯Ø§Ø¦Ù…Ø§Ù‹)
    list.sort((a, b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0));
    
    list.forEach((p) => {
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¥Ù†Ø¯ÙƒØ³ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©
      const originalIndex = data.perfumes.indexOf(p);
      grid.innerHTML += `
        <div class="card" onclick="addToCart(${originalIndex})">
          ${p.discount ? '<span class="badge">ØªØ®ÙÙŠØ¶</span>' : ''}
          <img src="${p.img || 'https://via.placeholder.com/150?text=Ø¹Ø·Ø±'}" loading="lazy" onerror="this.src='https://via.placeholder.com/150?text=Ø¹Ø·Ø±'">
          <h4>${p.name}</h4>
          <p style="font-size:0.8rem; color:#aaa; height:30px; overflow:hidden;">${p.desc || ''}</p>
          <div class="price">${p.price} Ø¯Ø¬/Ù…Ù„</div>
          <button style="margin-top:5px; font-size:0.8rem;">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø© +</button>
        </div>
      `;
    });
  }

  function sortPerfumes(mode) {
    if (mode === 'low') data.perfumes.sort((a,b) => a.price - b.price);
    if (mode === 'high') data.perfumes.sort((a,b) => b.price - a.price);
    renderPerfumes();
  }

  function addToCart(perfumeIdx) {
    if (currentBottleIdx === null) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø²Ø¬Ø§Ø¬Ø© Ø£ÙˆÙ„Ø§Ù‹!");
    
    const p = data.perfumes[perfumeIdx];
    const b = data.bottles[currentBottleIdx];
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø±: (Ø³Ø¹Ø± Ø§Ù„Ù…Ù„ÙŠÙ„ØªØ± * Ø§Ù„Ø³Ø¹Ø©) + Ø³Ø¹Ø± Ø§Ù„Ø²Ø¬Ø§Ø¬Ø©
    const itemTotal = (p.price * b.capacity) + b.price;
    
    cart.push({
      pName: p.name,
      bName: b.name,
      capacity: b.capacity,
      price: itemTotal
    });
    
    renderCart();
    document.getElementById('cartSection').classList.remove('hidden');
    document.getElementById('cartSection').scrollIntoView({behavior: 'smooth'});
  }

  function renderCart() {
    const list = document.getElementById('cartList');
    list.innerHTML = '';
    let total = 0;
    
    cart.forEach((item, idx) => {
      total += item.price;
      list.innerHTML += `
        <div class="cart-item">
          <div>
            <strong>${item.pName}</strong> <br>
            <small style="color:#aaa">Ø²Ø¬Ø§Ø¬Ø©: ${item.bName} (${item.capacity} Ù…Ù„)</small>
          </div>
          <div style="text-align:left">
            <div style="color:var(--gold)">${item.price} Ø¯Ø¬</div>
            <button onclick="removeFromCart(${idx})" class="danger" style="padding:2px 8px; font-size:0.7rem;">Ø­Ø°Ù</button>
          </div>
        </div>
      `;
    });
    
    const grandTotal = total + data.shipping;
    document.getElementById('cartTotalDisplay').innerHTML = `
      Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total} Ø¯Ø¬ <br>
      <span style="font-size:0.9rem; color:#fff">+ ØªÙˆØµÙŠÙ„: ${data.shipping} Ø¯Ø¬</span> <br>
      ------------------ <br>
      Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${grandTotal} Ø¯Ø¬
    `;
  }

  function removeFromCart(idx) {
    cart.splice(idx, 1);
    renderCart();
    if (cart.length === 0) document.getElementById('cartSection').classList.add('hidden');
  }

  function sendWhatsAppOrder() {
    const name = document.getElementById('custName').value.trim();
    const phone = document.getElementById('custPhone').value.trim();
    const address = document.getElementById('custAddress').value.trim();
    const notes = document.getElementById('custNotes').value.trim();
    
    if (!name || !address || !phone) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†)!");
    if (cart.length === 0) return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!");

    let orderDetails = "";
    let subTotal = 0;
    
    cart.forEach(item => {
      subTotal += item.price;
      orderDetails += `â–ªï¸ ${item.pName} (${item.capacity}Ù…Ù„) - ${item.price} Ø¯Ø¬\n`;
    });
    
    const total = subTotal + data.shipping;
    
    const msg = `
*Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù…ØªØ¬Ø± Ø§Ù„Ø¹Ø·ÙˆØ±* ğŸ›ï¸
------------------------
Ø§Ù„Ø§Ø³Ù…: ${name}
ğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: ${phone}
Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${address}
------------------------
*Ø§Ù„Ø·Ù„Ø¨Ø§Øª:*
${orderDetails}
------------------------
Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${subTotal} Ø¯Ø¬
Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„: ${data.shipping} Ø¯Ø¬
*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${total} Ø¯Ø¬*
------------------------
Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${notes}
    `.trim();

    const url = `https://wa.me/${ADMIN_PHONE}?text=${encodeURIComponent(msg)}`;
    window.open(url, '_blank');
  }

  /* --- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† --- */

  function openAdmin() {
    const pass = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:");
    if (pass === ADMIN_PASS) {
      document.getElementById('adminPanel').style.display = 'block';
      renderAdminList();
    } else if(pass) {
      alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©");
    }
  }

  function switchAdminTab(tab) {
    adminCurrentTab = tab;
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    document.getElementById('tabPerfumes').className = tab === 'perfumes' ? '' : 'secondary';
    document.getElementById('tabBottles').className = tab === 'bottles' ? '' : 'secondary';
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±Ù…
    resetForm();
    if (tab === 'bottles') {
      document.getElementById('formTitle').innerText = 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²Ø¬Ø§Ø¬Ø§Øª';
      document.getElementById('prodCapacity').style.display = 'block';
      document.getElementById('perfumeOptions').style.display = 'none';
      document.getElementById('prodDesc').style.display = 'none';
      document.getElementById('prodPrice').placeholder = 'Ø³Ø¹Ø± Ø§Ù„Ø²Ø¬Ø§Ø¬Ø© Ø§Ù„ÙØ§Ø±ØºØ©';
    } else {
      document.getElementById('formTitle').innerText = 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø·ÙˆØ±';
      document.getElementById('prodCapacity').style.display = 'none';
      document.getElementById('perfumeOptions').style.display = 'flex';
      document.getElementById('prodDesc').style.display = 'block';
      document.getElementById('prodPrice').placeholder = 'Ø³Ø¹Ø± Ø§Ù„Ù…Ù„ÙŠÙ„ØªØ± Ø§Ù„ÙˆØ§Ø­Ø¯';
    }
    renderAdminList();
  }

  function saveProduct() {
    const name = document.getElementById('prodName').value;
    const price = parseFloat(document.getElementById('prodPrice').value);
    const img = document.getElementById('imgData').value;
    const index = parseInt(document.getElementById('editIndex').value);
    
    if (!name || isNaN(price)) return alert("Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø³Ø¹Ø± Ù…Ø·Ù„ÙˆØ¨Ø§Ù†");

    let item = { name, price, img };

    if (adminCurrentTab === 'perfumes') {
      item.desc = document.getElementById('prodDesc').value;
      item.discount = document.getElementById('isDiscount').checked;
      item.pinned = document.getElementById('isPinned').checked;
      
      if (index === -1) data.perfumes.push(item);
      else data.perfumes[index] = item;
      localStorage.setItem('perfumes', JSON.stringify(data.perfumes));
      
    } else {
      const cap = parseInt(document.getElementById('prodCapacity').value);
      if (!cap) return alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø³Ø¹Ø© Ø§Ù„Ø²Ø¬Ø§Ø¬Ø©");
      item.capacity = cap;
      
      if (index === -1) data.bottles.push(item);
      else data.bottles[index] = item;
      localStorage.setItem('bottles', JSON.stringify(data.bottles));
    }

    alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!");
    resetForm();
    renderAdminList();
    renderBottlesUser(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  }

  function renderAdminList() {
    const list = document.getElementById('adminList');
    list.innerHTML = '';
    const array = adminCurrentTab === 'perfumes' ? data.perfumes : data.bottles;

    array.forEach((item, idx) => {
      list.innerHTML += `
        <div class="admin-table-item">
          <img src="${item.img || 'https://via.placeholder.com/50'}" onerror="this.src='https://via.placeholder.com/50'">
          <div class="info">
            <strong>${item.name}</strong> <br>
            <small>${item.price} Ø¯Ø¬ - ${adminCurrentTab==='bottles' ? item.capacity+'Ù…Ù„' : (item.pinned?'Ù…Ø«Ø¨Øª':'')}</small>
          </div>
          <div class="admin-actions">
            <button onclick="editProduct(${idx})" style="background:var(--gold-dim)">ØªØ¹Ø¯ÙŠÙ„</button>
            <button onclick="deleteProduct(${idx})" class="danger">X</button>
          </div>
        </div>
      `;
    });
  }

  function editProduct(idx) {
    const array = adminCurrentTab === 'perfumes' ? data.perfumes : data.bottles;
    const item = array[idx];
    
    document.getElementById('editIndex').value = idx;
    document.getElementById('prodName').value = item.name;
    document.getElementById('prodPrice').value = item.price;
    document.getElementById('imgData').value = item.img || '';
    
    if (item.img) {
      document.getElementById('imgPreview').src = item.img;
      document.getElementById('imgPreview').style.display = 'block';
      
      // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
      if (item.img.startsWith('data:')) {
        document.getElementById('imageInfo').innerHTML = '<div>ØµÙˆØ±Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹</div>';
      } else if (item.img.includes('cloudinary')) {
        document.getElementById('imageInfo').innerHTML = '<div>ØµÙˆØ±Ø© Ù…Ù† Cloudinary</div>';
      } else {
        document.getElementById('imageInfo').innerHTML = '<div>ØµÙˆØ±Ø© Ù…Ù† Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ</div>';
      }
    }

    if (adminCurrentTab === 'perfumes') {
      document.getElementById('prodDesc').value = item.desc || '';
      document.getElementById('isDiscount').checked = item.discount || false;
      document.getElementById('isPinned').checked = item.pinned || false;
    } else {
      document.getElementById('prodCapacity').value = item.capacity;
    }
    
    // ØªØ­Ø¯ÙŠØ¯ Ø®ÙŠØ§Ø± Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
    if (item.img) {
      if (item.img.includes('cloudinary')) {
        showUploadOption('cloudinary');
      } else if (item.img.startsWith('http')) {
        document.getElementById('driveUrl').value = item.img;
        showUploadOption('drive');
      } else {
        showUploadOption('file');
      }
    }
    
    // Ø³ÙƒØ±ÙˆÙ„ Ù„Ù„ÙÙˆØ±Ù…
    document.getElementById('addForm').scrollIntoView({behavior: 'smooth'});
  }

  function deleteProduct(idx) {
    if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) return;
    
    if (adminCurrentTab === 'perfumes') {
      data.perfumes.splice(idx, 1);
      localStorage.setItem('perfumes', JSON.stringify(data.perfumes));
    } else {
      data.bottles.splice(idx, 1);
      localStorage.setItem('bottles', JSON.stringify(data.bottles));
    }
    renderAdminList();
    renderBottlesUser();
  }

  function resetForm() {
    document.getElementById('editIndex').value = -1;
    document.getElementById('prodName').value = '';
    document.getElementById('prodPrice').value = '';
    document.getElementById('prodCapacity').value = '';
    document.getElementById('prodDesc').value = '';
    document.getElementById('imgData').value = '';
    document.getElementById('imgInput').value = '';
    document.getElementById('cloudinaryInput').value = '';
    document.getElementById('driveUrl').value = '';
    document.getElementById('imgPreview').style.display = 'none';
    document.getElementById('imageInfo').innerHTML = '';
    document.getElementById('uploadStatus').innerHTML = '';
    document.getElementById('driveStatus').innerHTML = '';
    document.getElementById('cloudinaryStatus').innerHTML = '';
    document.getElementById('isDiscount').checked = false;
    document.getElementById('isPinned').checked = false;
    document.getElementById('uploadProgress').style.width = '0%';
    
    // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø®ÙŠØ§Ø± Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    showUploadOption('file');
  }

  function saveShipPrice() {
    const p = document.getElementById('shipPriceInput').value;
    data.shipping = parseInt(p);
    localStorage.setItem('shipping', data.shipping);
    alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„');
  }
</script>

</body>
</html>
